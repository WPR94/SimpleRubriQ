# Stripe Setup Guide - Simple Rubriq

Complete guide for setting up Stripe payment integration with 4-tier pricing.

---

## ğŸ“Š Pricing Structure

### ğŸŸ¦ Tier 1 â€” Free (Forever)
- **Price**: Â£0/month
- **Stripe Product Name**: `Simple Rubriq â€“ Free Plan`
- **Features**:
  - 3 AI feedback generations per day
  - 1 saved rubric
  - Basic essay grading (summaries + brief improvements)
  - Text-only + small PDF uploads
  - Watermarked reports ("Generated by Simple Rubriq")
  - No feedback history, no analytics
  - Limited OCR (short documents only)
- **Purpose**: Let teachers experience the app without cost while protecting OpenAI expenses

---

### ğŸŸ© Tier 2 â€” Teacher Pro (Most Popular)
- **Price**: Â£6.99/month
- **Stripe Product Name**: `Simple Rubriq â€“ Teacher Pro`
- **Features**:
  - âœ… Unlimited AI essay feedback
  - âœ… Unlimited saved rubrics
  - âœ… Full OCR support (PDF, DOCX, scanned writing)
  - âœ… Full feedback history dashboard
  - âœ… Sentence-level rubric alignment
  - âœ… Faster AI processing queue
  - âœ… Professional export options (PDF reports, copyable text)
  - âœ… Priority email support
- **Best For**: Individual teachers marking GCSE, A-Level, BTEC, or functional skills writing
- **Profit**: Â£5.29/month after Stripe + OpenAI costs

---

### ğŸŸ§ Tier 3 â€” Teacher Pro+
- **Price**: Â£12.99/month
- **Stripe Product Name**: `Simple Rubriq â€“ Teacher Pro+`
- **Includes everything in Pro, PLUS**:
  - ğŸ“Š Class analytics (student trends, rubric mastery insights)
  - ğŸ“¦ Batch grading (upload 30â€“100 essays at once)
  - ğŸ“‹ Rubric presets + reusable templates
  - ğŸ“¤ CSV/LMS export options
  - âš¡ Priority processing (faster queue + priority compute)
  - ğŸš€ Early access to new AI features (beta tools)
- **Best For**: English department leads, tutors handling large essay volumes, teachers marking coursework in bulk
- **Profit**: Â£9.81â€“Â£11.11/month depending on AI usage

---

### ğŸŸ¨ Tier 4 â€” School / Department Plan
- **Price**: Â£350â€“Â£1,200/year (annual billing)
- **Stripe Product Name**: `Simple Rubriq â€“ School Plan (Annual)`
- **Pricing Structure**:
  | Teachers | Annual Price |
  |----------|-------------|
  | 1â€“5      | Â£350/year   |
  | 6â€“15     | Â£650/year   |
  | 16â€“30    | Â£1,200/year |

- **Features**:
  - ğŸ‘¥ Full access for all included teachers
  - ğŸ›ï¸ Admin dashboard
  - ğŸ“š Shared rubric libraries
  - ğŸ“ˆ Department-wide feedback analytics
  - ğŸ“Š Usage tracking + export
  - ğŸ”’ Data retention & compliance controls
  - ğŸ“ Bulk onboarding
  - ğŸ†˜ Dedicated support team
  - âš™ï¸ Option for custom features
- **Best For**: English departments, multi-teacher teams, schools seeking predictable pricing
- **Profit Margin**: ~90% after OpenAI + infrastructure costs

---

## ğŸš€ Setup Instructions

### Step 1: Create Stripe Products

1. Go to **Stripe Dashboard** â†’ **Products** â†’ **Add Product**

2. Create **Teacher Pro**:
   - Product name: `Simple Rubriq â€“ Teacher Pro`
   - Price: Â£6.99
   - Billing period: Monthly
   - Click **Save product**
   - **COPY THE PRICE ID** (starts with `price_...`)

3. Create **Teacher Pro+**:
   - Product name: `Simple Rubriq â€“ Teacher Pro+`
   - Price: Â£12.99
   - Billing period: Monthly
   - Click **Save product**
   - **COPY THE PRICE ID** (starts with `price_...`)

4. (Optional) Create **School Plan** tiers:
   - Create 3 separate products for different seat counts
   - Set billing to **Yearly**
   - Use custom pricing for quote-based sales

---

### Step 2: Configure Supabase Secrets

Run these commands in your terminal (inside the `markmate/` directory):

```bash
# Teacher Pro Price ID (Â£6.99/month)
npx supabase secrets set PRICE_ID_TEACHER_PRO=price_XXXXXXXXXXXXX

# Teacher Pro+ Price ID (Â£12.99/month)
npx supabase secrets set PRICE_ID_TEACHER_PRO_PLUS=price_YYYYYYYYYYYYYYY

# Your Stripe Secret API Key (get from Stripe Dashboard â†’ Developers â†’ API Keys)
npx supabase secrets set STRIPE_API_KEY=sk_test_ZZZZZZZZZZZZZZZZZZZZZZZZZZZZZ

# Stripe Webhook Signing Secret (get from Stripe Dashboard â†’ Webhooks)
npx supabase secrets set STRIPE_WEBHOOK_SIGNING_SECRET=whsec_AAAAAAAAAAAA

# Your Supabase Anonymous Key (get from Supabase Dashboard â†’ Settings â†’ API)
npx supabase secrets set SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Your production app URL (Vercel deployment URL)
npx supabase secrets set DEFAULT_ORIGIN=https://your-app.vercel.app
```

---

### Step 3: Run Database Migration

1. Go to **Supabase Dashboard** â†’ **SQL Editor**
2. Paste and run the SQL from `supabase/migrations/20251207000000_add_subscriptions.sql`
3. This creates:
   - `plan` column on `profiles` table (defaults to 'free')
   - `subscriptions` table to track Stripe subscription data
   - RLS policies for secure access

---

### Step 4: Configure Stripe Webhook

1. Go to **Stripe Dashboard** â†’ **Developers** â†’ **Webhooks**
2. Click **Add endpoint**
3. Set endpoint URL:
   ```
   https://hyovomyhoxhvhogfvupj.supabase.co/functions/v1/stripe-webhook
   ```
4. Select events to listen for:
   - `checkout.session.completed`
   - `customer.subscription.updated`
   - `customer.subscription.deleted`
5. Click **Add endpoint**
6. **COPY THE SIGNING SECRET** (starts with `whsec_...`) and add it to Supabase secrets (see Step 2)

---

### Step 5: Deploy Edge Functions

Deploy the Stripe integration functions to Supabase:

```bash
# Deploy checkout session creator
npx supabase functions deploy create-checkout

# Deploy webhook handler
npx supabase functions deploy stripe-webhook
```

---

## âœ… Testing the Integration

### Test Free â†’ Pro Upgrade Flow

1. Create a test account on your app
2. Go to `/pricing` page
3. Click **Upgrade to Pro** on Teacher Pro card
4. Complete checkout using Stripe test card: `4242 4242 4242 4242`
5. After payment, verify:
   - User redirected to success page
   - Database updated: `profiles.plan = 'teacher_pro'`
   - `subscriptions` table has new row with Stripe subscription ID

### Test Pro â†’ Pro+ Upgrade

1. Log in with a Pro account
2. Go to `/pricing`
3. Click **Upgrade to Pro+**
4. Complete checkout
5. Verify plan updates to `teacher_pro_plus`

---

## ğŸ”’ Security Notes

- âœ… Never commit API keys to git
- âœ… Use Stripe test mode keys during development
- âœ… Regenerate any exposed API keys immediately
- âœ… Webhook signature verification is implemented to prevent fraud
- âœ… JWT validation ensures only authenticated users can create checkout sessions

---

## ğŸ“ Support & Custom Plans

For School Plan inquiries, users should email: **sales@simplerubriq.com**

You can customize school pricing based on:
- Number of teachers (seats)
- Required features (SSO, custom integrations)
- Compliance needs (data residency, DPA agreements)
- Contract length (annual vs multi-year discounts)

---

## ğŸ‰ You're Done!

Users can now:
- âœ… Sign up for free accounts
- âœ… Upgrade to Teacher Pro (Â£6.99/month)
- âœ… Upgrade to Teacher Pro+ (Â£12.99/month)
- âœ… Contact sales for School Plans
- âœ… Manage subscriptions via Stripe Customer Portal
- âœ… Cancel anytime with automatic access revocation
